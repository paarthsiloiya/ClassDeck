<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>app.routes - ClassDeck 1.0.0 documentation</title><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=14737038" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="app.routes"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      
      
      <strong>ClassDeck</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">ClassDeck Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../app.html">app package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html">config module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../run.html">run module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../init_db.html">init_db module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../update_db.html">update_db module</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">ClassDeck</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">app.routes</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for app.routes</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span data-line="2"><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span data-line="3"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">flash</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">flask_login</span><span class="w"> </span><span class="kn">import</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">login_user</span><span class="p">,</span> <span class="n">logout_user</span><span class="p">,</span> <span class="n">login_required</span>
</span><span data-line="6"><span class="kn">from</span><span class="w"> </span><span class="nn">google_auth_oauthlib.flow</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flow</span>
</span><span data-line="7"><span class="kn">from</span><span class="w"> </span><span class="nn">google.oauth2.credentials</span><span class="w"> </span><span class="kn">import</span> <span class="n">Credentials</span>
</span><span data-line="8"><span class="kn">from</span><span class="w"> </span><span class="nn">googleapiclient.discovery</span><span class="w"> </span><span class="kn">import</span> <span class="n">build</span>
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">googleapiclient.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpError</span>
</span><span data-line="10"><span class="kn">import</span><span class="w"> </span><span class="nn">google.auth.transport.requests</span>
</span><span data-line="11"><span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">login</span>
</span><span data-line="12"><span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Course</span><span class="p">,</span> <span class="n">CourseTag</span><span class="p">,</span> <span class="n">ItemTag</span><span class="p">,</span> <span class="n">MutedItem</span><span class="p">,</span> <span class="n">UserTag</span>
</span><span data-line="13">
</span><span data-line="14"><span class="c1"># Helper for file icons</span>
<div class="viewcode-block" id="get_file_icon">
<a class="viewcode-back" href="../../app.html#app.routes.get_file_icon">[docs]</a>
</span><span data-line="15"><span class="k">def</span><span class="w"> </span><span class="nf">get_file_icon</span><span class="p">(</span><span class="n">mime_type</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="16"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="17"><span class="sd">    Determines the appropriate Font Awesome icon class for a given file MIME type.</span>
</span><span data-line="18">
</span><span data-line="19"><span class="sd">    Args:</span>
</span><span data-line="20"><span class="sd">        mime_type (str): The MIME type of the file (e.g., &#39;application/pdf&#39;).</span>
</span><span data-line="21"><span class="sd">        title (str, optional): The title of the file (unused, but kept for compatibility).</span>
</span><span data-line="22">
</span><span data-line="23"><span class="sd">    Returns:</span>
</span><span data-line="24"><span class="sd">        str: A string containing the CSS classes for the icon (e.g., &#39;file-pdf text-red-500&#39;).</span>
</span><span data-line="25"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="26">    <span class="k">if</span> <span class="ow">not</span> <span class="n">mime_type</span><span class="p">:</span>
</span><span data-line="27">        <span class="k">return</span> <span class="s1">&#39;file text-gray-500&#39;</span>
</span><span data-line="28">    
</span><span data-line="29">    <span class="n">mime_type</span> <span class="o">=</span> <span class="n">mime_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span data-line="30">    <span class="k">if</span> <span class="s1">&#39;pdf&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
</span><span data-line="31">        <span class="k">return</span> <span class="s1">&#39;file-pdf text-red-500&#39;</span>
</span><span data-line="32">    <span class="k">elif</span> <span class="s1">&#39;image&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
</span><span data-line="33">        <span class="k">return</span> <span class="s1">&#39;file-image text-purple-500&#39;</span>
</span><span data-line="34">    <span class="k">elif</span> <span class="s1">&#39;video&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
</span><span data-line="35">        <span class="k">return</span> <span class="s1">&#39;file-video text-red-600&#39;</span>
</span><span data-line="36">    <span class="k">elif</span> <span class="s1">&#39;audio&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
</span><span data-line="37">        <span class="k">return</span> <span class="s1">&#39;file-audio text-yellow-500&#39;</span>
</span><span data-line="38">    <span class="k">elif</span> <span class="s1">&#39;sheet&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span> <span class="ow">or</span> <span class="s1">&#39;excel&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span> <span class="ow">or</span> <span class="s1">&#39;spreadsheet&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
</span><span data-line="39">        <span class="k">return</span> <span class="s1">&#39;file-excel text-green-500&#39;</span>
</span><span data-line="40">    <span class="k">elif</span> <span class="s1">&#39;presentation&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span> <span class="ow">or</span> <span class="s1">&#39;powerpoint&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span> <span class="ow">or</span> <span class="s1">&#39;slides&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
</span><span data-line="41">        <span class="k">return</span> <span class="s1">&#39;file-powerpoint text-orange-500&#39;</span>
</span><span data-line="42">    <span class="k">elif</span> <span class="s1">&#39;document&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span> <span class="ow">or</span> <span class="s1">&#39;word&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
</span><span data-line="43">        <span class="k">return</span> <span class="s1">&#39;file-word text-blue-500&#39;</span>
</span><span data-line="44">    <span class="k">elif</span> <span class="s1">&#39;form&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
</span><span data-line="45">        <span class="k">return</span> <span class="s1">&#39;file-alt text-purple-600&#39;</span>
</span><span data-line="46">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="47">        <span class="k">return</span> <span class="s1">&#39;file text-gray-500&#39;</span></div>

</span><span data-line="48">
</span><span data-line="49"><span class="n">app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_file_icon</span><span class="o">=</span><span class="n">get_file_icon</span><span class="p">)</span>
</span><span data-line="50">
<div class="viewcode-block" id="load_user">
<a class="viewcode-back" href="../../app.html#app.routes.load_user">[docs]</a>
</span><span data-line="51"><span class="nd">@login</span><span class="o">.</span><span class="n">user_loader</span>
</span><span data-line="52"><span class="k">def</span><span class="w"> </span><span class="nf">load_user</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
</span><span data-line="53"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="54"><span class="sd">    Flask-Login user loader callback.</span>
</span><span data-line="55"><span class="sd">    </span>
</span><span data-line="56"><span class="sd">    Args:</span>
</span><span data-line="57"><span class="sd">        id (str): The user ID from the session.</span>
</span><span data-line="58"><span class="sd">        </span>
</span><span data-line="59"><span class="sd">    Returns:</span>
</span><span data-line="60"><span class="sd">        User: The User object corresponding to the ID.</span>
</span><span data-line="61"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="62">    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span></div>

</span><span data-line="63">
<div class="viewcode-block" id="index">
<a class="viewcode-back" href="../../app.html#app.routes.index">[docs]</a>
</span><span data-line="64"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span data-line="65"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/index&#39;</span><span class="p">)</span>
</span><span data-line="66"><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
</span><span data-line="67"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="68"><span class="sd">    Renders the main dashboard (index) page.</span>
</span><span data-line="69"><span class="sd">    </span>
</span><span data-line="70"><span class="sd">    Fetches the user&#39;s courses from Google Classroom, merges them with local database overrides,</span>
</span><span data-line="71"><span class="sd">    checks for new assignments, and handles display sorting and filtering.</span>
</span><span data-line="72"><span class="sd">    </span>
</span><span data-line="73"><span class="sd">    Returns:</span>
</span><span data-line="74"><span class="sd">        str: Rendered HTML template for the dashboard.</span>
</span><span data-line="75"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="76">    <span class="n">courses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="77">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
</span><span data-line="78">        <span class="c1"># Build credentials from stored user data</span>
</span><span data-line="79">        <span class="n">credentials</span> <span class="o">=</span> <span class="n">Credentials</span><span class="p">(</span>
</span><span data-line="80">            <span class="n">token</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">access_token</span><span class="p">,</span>
</span><span data-line="81">            <span class="n">refresh_token</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
</span><span data-line="82">            <span class="n">token_uri</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">token_uri</span><span class="p">,</span>
</span><span data-line="83">            <span class="n">client_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
</span><span data-line="84">            <span class="n">client_secret</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">client_secret</span><span class="p">,</span>
</span><span data-line="85">            <span class="n">scopes</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="86">        <span class="p">)</span>
</span><span data-line="87">
</span><span data-line="88">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="89">            <span class="c1"># Get courses</span>
</span><span data-line="90">            <span class="n">classroom_service</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="s1">&#39;classroom&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">)</span>
</span><span data-line="91">            <span class="n">results</span> <span class="o">=</span> <span class="n">classroom_service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">studentId</span><span class="o">=</span><span class="s1">&#39;me&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="92">            <span class="n">google_courses</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courses&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="93">
</span><span data-line="94">            <span class="c1"># Check for new assignments (last 24 hours)</span>
</span><span data-line="95">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="96">                <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span data-line="97">                <span class="n">yesterday</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="98">                
</span><span data-line="99">                <span class="c1"># Initialize seen list in session if not present</span>
</span><span data-line="100">                <span class="k">if</span> <span class="s1">&#39;seen_assignments&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
</span><span data-line="101">                    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;seen_assignments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="102">                
</span><span data-line="103">                <span class="c1"># Use a set for faster lookups and to avoid duplicates in session</span>
</span><span data-line="104">                <span class="n">seen_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;seen_assignments&#39;</span><span class="p">])</span>
</span><span data-line="105">                <span class="n">new_seen_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="106">
</span><span data-line="107">                <span class="k">def</span><span class="w"> </span><span class="nf">check_new_assignments_callback</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
</span><span data-line="108">                    <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
</span><span data-line="109">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking assignments for </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="110">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="111">                        <span class="n">course_work</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courseWork&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="112">                        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">course_work</span><span class="p">:</span>
</span><span data-line="113">                            <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workType&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ASSIGNMENT&#39;</span><span class="p">:</span>
</span><span data-line="114">                                <span class="n">creation_time_str</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;creationTime&#39;</span><span class="p">)</span>
</span><span data-line="115">                                <span class="k">if</span> <span class="n">creation_time_str</span><span class="p">:</span>
</span><span data-line="116">                                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="117">                                        <span class="n">creation_time_str</span> <span class="o">=</span> <span class="n">creation_time_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span data-line="118">                                        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">creation_time_str</span><span class="p">:</span>
</span><span data-line="119">                                            <span class="n">creation_time_str</span> <span class="o">=</span> <span class="n">creation_time_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="120">                                        
</span><span data-line="121">                                        <span class="n">creation_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">creation_time_str</span><span class="p">)</span>
</span><span data-line="122">                                        
</span><span data-line="123">                                        <span class="k">if</span> <span class="n">creation_dt</span> <span class="o">&gt;</span> <span class="n">yesterday</span><span class="p">:</span>
</span><span data-line="124">                                            <span class="n">work_id</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span><span data-line="125">                                            <span class="c1"># Only notify if we haven&#39;t seen this assignment in this session</span>
</span><span data-line="126">                                            <span class="k">if</span> <span class="n">work_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_ids</span><span class="p">:</span>
</span><span data-line="127">                                                <span class="n">course_name</span> <span class="o">=</span> <span class="s2">&quot;Class&quot;</span>
</span><span data-line="128">                                                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">google_courses</span><span class="p">:</span>
</span><span data-line="129">                                                    <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_id</span><span class="p">:</span>
</span><span data-line="130">                                                        <span class="n">course_name</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</span><span data-line="131">                                                        <span class="k">break</span>
</span><span data-line="132">                                                
</span><span data-line="133">                                                <span class="n">flash</span><span class="p">({</span>
</span><span data-line="134">                                                    <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;New Assignment: </span><span class="si">{</span><span class="n">work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">course_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="135">                                                    <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;course_stream&#39;</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">)</span>
</span><span data-line="136">                                                <span class="p">},</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span><span data-line="137">                                                
</span><span data-line="138">                                                <span class="n">new_seen_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">work_id</span><span class="p">)</span>
</span><span data-line="139">                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span data-line="140">                                        <span class="k">pass</span>
</span><span data-line="141">
</span><span data-line="142">                <span class="n">batch</span> <span class="o">=</span> <span class="n">classroom_service</span><span class="o">.</span><span class="n">new_batch_http_request</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">check_new_assignments_callback</span><span class="p">)</span>
</span><span data-line="143">                <span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">google_courses</span><span class="p">:</span>
</span><span data-line="144">                    <span class="k">if</span> <span class="n">course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courseState&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ACTIVE&#39;</span><span class="p">:</span>
</span><span data-line="145">                        <span class="n">batch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">classroom_service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">courseWork</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
</span><span data-line="146">                            <span class="n">courseId</span><span class="o">=</span><span class="n">course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> 
</span><span data-line="147">                            <span class="n">orderBy</span><span class="o">=</span><span class="s1">&#39;updateTime desc&#39;</span><span class="p">,</span> 
</span><span data-line="148">                            <span class="n">pageSize</span><span class="o">=</span><span class="mi">5</span>
</span><span data-line="149">                        <span class="p">),</span> <span class="n">request_id</span><span class="o">=</span><span class="n">course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
</span><span data-line="150">                
</span><span data-line="151">                <span class="k">if</span> <span class="n">google_courses</span><span class="p">:</span>
</span><span data-line="152">                    <span class="n">batch</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="153">                    
</span><span data-line="154">                <span class="c1"># Update session with new seen IDs</span>
</span><span data-line="155">                <span class="k">if</span> <span class="n">new_seen_ids</span><span class="p">:</span>
</span><span data-line="156">                    <span class="n">seen_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_seen_ids</span><span class="p">)</span>
</span><span data-line="157">                    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;seen_assignments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">seen_ids</span><span class="p">)</span>
</span><span data-line="158">                    <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="159">                    
</span><span data-line="160">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="161">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking new assignments: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="162">            
</span><span data-line="163">            <span class="c1"># Merge with local data</span>
</span><span data-line="164">            <span class="k">for</span> <span class="n">g_course</span> <span class="ow">in</span> <span class="n">google_courses</span><span class="p">:</span>
</span><span data-line="165">                <span class="n">local_course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">g_course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="166">                
</span><span data-line="167">                <span class="c1"># Create a display object (dict)</span>
</span><span data-line="168">                <span class="n">display_course</span> <span class="o">=</span> <span class="n">g_course</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="169">                <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;is_archived&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="170">                
</span><span data-line="171">                <span class="c1"># Determine if archived (Google state or Local override)</span>
</span><span data-line="172">                <span class="k">if</span> <span class="n">g_course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courseState&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ARCHIVED&#39;</span><span class="p">:</span>
</span><span data-line="173">                    <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;is_archived&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="174">                
</span><span data-line="175">                <span class="k">if</span> <span class="n">local_course</span><span class="p">:</span>
</span><span data-line="176">                    <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_name</span><span class="p">:</span>
</span><span data-line="177">                        <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_name</span>
</span><span data-line="178">                    <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_section</span><span class="p">:</span>
</span><span data-line="179">                        <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_section</span>
</span><span data-line="180">                    <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_code</span><span class="p">:</span>
</span><span data-line="181">                        <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;enrollmentCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_code</span> <span class="c1"># Override enrollment code for display</span>
</span><span data-line="182">                    <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">is_archived</span><span class="p">:</span>
</span><span data-line="183">                        <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;is_archived&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="184">                    <span class="c1"># Add other custom fields if needed for template</span>
</span><span data-line="185">                    <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;custom_banner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_banner</span>
</span><span data-line="186">                    <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;custom_icon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_icon</span>
</span><span data-line="187">                    <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;custom_teacher_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_teacher_name</span>
</span><span data-line="188">                    <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;cached_teacher_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">cached_teacher_name</span>
</span><span data-line="189">                    <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;display_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">display_order</span>
</span><span data-line="190">                    <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">user_tags</span>
</span><span data-line="191">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="192">                    <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="193">                
</span><span data-line="194">                <span class="c1"># Fetch teacher name if missing</span>
</span><span data-line="195">                <span class="k">if</span> <span class="ow">not</span> <span class="n">display_course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_teacher_name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">display_course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cached_teacher_name&#39;</span><span class="p">):</span>
</span><span data-line="196">                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="197">                        <span class="c1"># We need to fetch the teacher profile. </span>
</span><span data-line="198">                        <span class="c1"># Note: This can be slow for many courses. Ideally, do this asynchronously or in batch.</span>
</span><span data-line="199">                        <span class="c1"># For now, we&#39;ll do it on demand and cache it.</span>
</span><span data-line="200">                        <span class="n">owner_id</span> <span class="o">=</span> <span class="n">g_course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ownerId&#39;</span><span class="p">)</span>
</span><span data-line="201">                        <span class="k">if</span> <span class="n">owner_id</span><span class="p">:</span>
</span><span data-line="202">                            <span class="n">user_profile</span> <span class="o">=</span> <span class="n">classroom_service</span><span class="o">.</span><span class="n">userProfiles</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">userId</span><span class="o">=</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="203">                            <span class="n">teacher_name</span> <span class="o">=</span> <span class="n">user_profile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fullName&#39;</span><span class="p">)</span>
</span><span data-line="204">                            
</span><span data-line="205">                            <span class="k">if</span> <span class="ow">not</span> <span class="n">local_course</span><span class="p">:</span>
</span><span data-line="206">                                <span class="n">local_course</span> <span class="o">=</span> <span class="n">Course</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">g_course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
</span><span data-line="207">                                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">local_course</span><span class="p">)</span>
</span><span data-line="208">                            
</span><span data-line="209">                            <span class="n">local_course</span><span class="o">.</span><span class="n">cached_teacher_name</span> <span class="o">=</span> <span class="n">teacher_name</span>
</span><span data-line="210">                            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="211">                            <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;cached_teacher_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">teacher_name</span>
</span><span data-line="212">                    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="213">                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
</span><span data-line="214">                             <span class="c1"># Check for missing scopes</span>
</span><span data-line="215">                            <span class="n">required_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;GOOGLE_SCOPES&#39;</span><span class="p">])</span>
</span><span data-line="216">                            <span class="n">current_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="217">                            
</span><span data-line="218">                            <span class="n">missing_scopes</span> <span class="o">=</span> <span class="n">required_scopes</span> <span class="o">-</span> <span class="n">current_scopes</span>
</span><span data-line="219">                            <span class="k">if</span> <span class="n">missing_scopes</span><span class="p">:</span>
</span><span data-line="220">                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing scopes for teacher fetch: </span><span class="si">{</span><span class="n">missing_scopes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="221">                                <span class="n">logout_user</span><span class="p">()</span>
</span><span data-line="222">                                <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;New permissions are required to view teacher names. Please log in again.&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span><span data-line="223">                                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span><span data-line="224">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching teacher for </span><span class="si">{</span><span class="n">g_course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="225">                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="226">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching teacher for </span><span class="si">{</span><span class="n">g_course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="227">
</span><span data-line="228">                <span class="c1"># Final Teacher Name Logic</span>
</span><span data-line="229">                <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;teacher_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display_course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_teacher_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">display_course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cached_teacher_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;Unknown Teacher&#39;</span>
</span><span data-line="230">
</span><span data-line="231">                <span class="k">if</span> <span class="ow">not</span> <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;is_archived&#39;</span><span class="p">]:</span>
</span><span data-line="232">                    <span class="n">courses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">display_course</span><span class="p">)</span>
</span><span data-line="233">                    
</span><span data-line="234">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="235">            <span class="c1"># Token might be expired and refresh failed, or other API error</span>
</span><span data-line="236">            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error fetching courses: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span><span data-line="237">            <span class="c1"># Optionally force re-login if token is invalid</span>
</span><span data-line="238">            
</span><span data-line="239">    <span class="c1"># Sort courses by display_order</span>
</span><span data-line="240">    <span class="n">courses</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display_order&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span data-line="241">    
</span><span data-line="242">    <span class="c1"># Get user tags for filtering</span>
</span><span data-line="243">    <span class="n">user_tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="244">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
</span><span data-line="245">        <span class="n">user_tags</span> <span class="o">=</span> <span class="n">UserTag</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span data-line="246">            
</span><span data-line="247">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Home&#39;</span><span class="p">,</span> <span class="n">courses</span><span class="o">=</span><span class="n">courses</span><span class="p">,</span> <span class="n">user_tags</span><span class="o">=</span><span class="n">user_tags</span><span class="p">)</span></div>

</span><span data-line="248">
<div class="viewcode-block" id="archived_courses">
<a class="viewcode-back" href="../../app.html#app.routes.archived_courses">[docs]</a>
</span><span data-line="249"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/archived&#39;</span><span class="p">)</span>
</span><span data-line="250"><span class="nd">@login_required</span>
</span><span data-line="251"><span class="k">def</span><span class="w"> </span><span class="nf">archived_courses</span><span class="p">():</span>
</span><span data-line="252"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="253"><span class="sd">    Renders the archived courses page.</span>
</span><span data-line="254"><span class="sd">    </span>
</span><span data-line="255"><span class="sd">    Displays courses that are either archived in Google Classroom or locally archived by the user.</span>
</span><span data-line="256"><span class="sd">    </span>
</span><span data-line="257"><span class="sd">    Returns:</span>
</span><span data-line="258"><span class="sd">        str: Rendered HTML template for archived courses.</span>
</span><span data-line="259"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="260">    <span class="n">courses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="261">    <span class="c1"># Build credentials from stored user data</span>
</span><span data-line="262">    <span class="n">credentials</span> <span class="o">=</span> <span class="n">Credentials</span><span class="p">(</span>
</span><span data-line="263">        <span class="n">token</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">access_token</span><span class="p">,</span>
</span><span data-line="264">        <span class="n">refresh_token</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
</span><span data-line="265">        <span class="n">token_uri</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">token_uri</span><span class="p">,</span>
</span><span data-line="266">        <span class="n">client_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
</span><span data-line="267">        <span class="n">client_secret</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">client_secret</span><span class="p">,</span>
</span><span data-line="268">        <span class="n">scopes</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="269">    <span class="p">)</span>
</span><span data-line="270">
</span><span data-line="271">    <span class="k">try</span><span class="p">:</span>
</span><span data-line="272">        <span class="c1"># Get courses</span>
</span><span data-line="273">        <span class="n">classroom_service</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="s1">&#39;classroom&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">)</span>
</span><span data-line="274">        <span class="n">results</span> <span class="o">=</span> <span class="n">classroom_service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">studentId</span><span class="o">=</span><span class="s1">&#39;me&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="275">        <span class="n">google_courses</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courses&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="276">        
</span><span data-line="277">        <span class="c1"># Merge with local data</span>
</span><span data-line="278">        <span class="k">for</span> <span class="n">g_course</span> <span class="ow">in</span> <span class="n">google_courses</span><span class="p">:</span>
</span><span data-line="279">            <span class="n">local_course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">g_course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="280">            
</span><span data-line="281">            <span class="n">display_course</span> <span class="o">=</span> <span class="n">g_course</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="282">            <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;is_archived&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="283">            
</span><span data-line="284">            <span class="k">if</span> <span class="n">g_course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courseState&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ARCHIVED&#39;</span><span class="p">:</span>
</span><span data-line="285">                <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;is_archived&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="286">            
</span><span data-line="287">            <span class="k">if</span> <span class="n">local_course</span><span class="p">:</span>
</span><span data-line="288">                <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_name</span><span class="p">:</span> <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_name</span>
</span><span data-line="289">                <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_section</span><span class="p">:</span> <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_section</span>
</span><span data-line="290">                <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_banner</span><span class="p">:</span> <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;custom_banner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_banner</span>
</span><span data-line="291">                <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">is_archived</span><span class="p">:</span> <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;is_archived&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="292">                <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;teacher_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_teacher_name</span> <span class="ow">or</span> <span class="n">local_course</span><span class="o">.</span><span class="n">cached_teacher_name</span>
</span><span data-line="293">            
</span><span data-line="294">            <span class="k">if</span> <span class="n">display_course</span><span class="p">[</span><span class="s1">&#39;is_archived&#39;</span><span class="p">]:</span>
</span><span data-line="295">                <span class="n">courses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">display_course</span><span class="p">)</span>
</span><span data-line="296">                
</span><span data-line="297">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="298">        <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error fetching archived courses: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span><span data-line="299">        
</span><span data-line="300">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Archived Classes&#39;</span><span class="p">,</span> <span class="n">courses</span><span class="o">=</span><span class="n">courses</span><span class="p">,</span> <span class="n">is_archived_view</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

</span><span data-line="301">
<div class="viewcode-block" id="missing_assignments">
<a class="viewcode-back" href="../../app.html#app.routes.missing_assignments">[docs]</a>
</span><span data-line="302"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/missing&#39;</span><span class="p">)</span>
</span><span data-line="303"><span class="nd">@login_required</span>
</span><span data-line="304"><span class="k">def</span><span class="w"> </span><span class="nf">missing_assignments</span><span class="p">():</span>
</span><span data-line="305"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="306"><span class="sd">    Renders the missing assignments page.</span>
</span><span data-line="307"><span class="sd">    </span>
</span><span data-line="308"><span class="sd">    Fetches all coursework from active courses, checks submission status, and identifies missing items.</span>
</span><span data-line="309"><span class="sd">    Filters out items that the user has locally muted.</span>
</span><span data-line="310"><span class="sd">    </span>
</span><span data-line="311"><span class="sd">    Returns:</span>
</span><span data-line="312"><span class="sd">        str: Rendered HTML template for missing assignments.</span>
</span><span data-line="313"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="314">    <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="315">    
</span><span data-line="316">    <span class="c1"># Build credentials</span>
</span><span data-line="317">    <span class="n">credentials</span> <span class="o">=</span> <span class="n">Credentials</span><span class="p">(</span>
</span><span data-line="318">        <span class="n">token</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">access_token</span><span class="p">,</span>
</span><span data-line="319">        <span class="n">refresh_token</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
</span><span data-line="320">        <span class="n">token_uri</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">token_uri</span><span class="p">,</span>
</span><span data-line="321">        <span class="n">client_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
</span><span data-line="322">        <span class="n">client_secret</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">client_secret</span><span class="p">,</span>
</span><span data-line="323">        <span class="n">scopes</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="324">    <span class="p">)</span>
</span><span data-line="325">    
</span><span data-line="326">    <span class="k">try</span><span class="p">:</span>
</span><span data-line="327">        <span class="n">service</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="s1">&#39;classroom&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">)</span>
</span><span data-line="328">        
</span><span data-line="329">        <span class="c1"># 1. Get all active courses</span>
</span><span data-line="330">        <span class="n">results</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">studentId</span><span class="o">=</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">courseStates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ACTIVE&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="331">        <span class="n">courses</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courses&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="332">        
</span><span data-line="333">        <span class="k">if</span> <span class="ow">not</span> <span class="n">courses</span><span class="p">:</span>
</span><span data-line="334">             <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;missing_assignments.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Missing Assignments&#39;</span><span class="p">,</span> <span class="n">assignments</span><span class="o">=</span><span class="p">[])</span>
</span><span data-line="335">
</span><span data-line="336">        <span class="c1"># Prepare data structures for batch results</span>
</span><span data-line="337">        <span class="n">all_course_work</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># course_id -&gt; [work]</span>
</span><span data-line="338">        <span class="n">all_submissions</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># course_id -&gt; [submission]</span>
</span><span data-line="339">        
</span><span data-line="340">        <span class="c1"># Callbacks</span>
</span><span data-line="341">        <span class="k">def</span><span class="w"> </span><span class="nf">cw_callback</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
</span><span data-line="342">            <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
</span><span data-line="343">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching coursework for </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="344">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="345">                <span class="n">all_course_work</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courseWork&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="346">
</span><span data-line="347">        <span class="k">def</span><span class="w"> </span><span class="nf">sub_callback</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
</span><span data-line="348">            <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
</span><span data-line="349">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching submissions for </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="350">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="351">                <span class="n">all_submissions</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;studentSubmissions&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="352">
</span><span data-line="353">        <span class="c1"># 2. Batch fetch CourseWork</span>
</span><span data-line="354">        <span class="n">batch_cw</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">new_batch_http_request</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">cw_callback</span><span class="p">)</span>
</span><span data-line="355">        <span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">courses</span><span class="p">:</span>
</span><span data-line="356">            <span class="n">batch_cw</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">courseWork</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">courseId</span><span class="o">=</span><span class="n">course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span> <span class="n">request_id</span><span class="o">=</span><span class="n">course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
</span><span data-line="357">        <span class="n">batch_cw</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="358">        
</span><span data-line="359">        <span class="c1"># 3. Batch fetch Submissions</span>
</span><span data-line="360">        <span class="n">batch_sub</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">new_batch_http_request</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">sub_callback</span><span class="p">)</span>
</span><span data-line="361">        <span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">courses</span><span class="p">:</span>
</span><span data-line="362">            <span class="n">batch_sub</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">courseWork</span><span class="p">()</span><span class="o">.</span><span class="n">studentSubmissions</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
</span><span data-line="363">                <span class="n">courseId</span><span class="o">=</span><span class="n">course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span data-line="364">                <span class="n">courseWorkId</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
</span><span data-line="365">                <span class="n">userId</span><span class="o">=</span><span class="s1">&#39;me&#39;</span><span class="p">,</span>
</span><span data-line="366">                <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CREATED&#39;</span><span class="p">,</span> <span class="s1">&#39;RECLAIMED_BY_STUDENT&#39;</span><span class="p">]</span>
</span><span data-line="367">            <span class="p">),</span> <span class="n">request_id</span><span class="o">=</span><span class="n">course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
</span><span data-line="368">        <span class="n">batch_sub</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="369">
</span><span data-line="370">        <span class="c1"># 4. Process Data</span>
</span><span data-line="371">        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span data-line="372">        
</span><span data-line="373">        <span class="c1"># Fetch muted items</span>
</span><span data-line="374">        <span class="n">muted_items</span> <span class="o">=</span> <span class="n">MutedItem</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span data-line="375">        <span class="n">muted_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="o">.</span><span class="n">google_item_id</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">muted_items</span><span class="p">}</span>
</span><span data-line="376">        
</span><span data-line="377">        <span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">courses</span><span class="p">:</span>
</span><span data-line="378">            <span class="n">c_id</span> <span class="o">=</span> <span class="n">course</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span data-line="379">            <span class="n">course_work</span> <span class="o">=</span> <span class="n">all_course_work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c_id</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="380">            <span class="n">submissions</span> <span class="o">=</span> <span class="n">all_submissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c_id</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="381">            
</span><span data-line="382">            <span class="k">if</span> <span class="ow">not</span> <span class="n">course_work</span><span class="p">:</span>
</span><span data-line="383">                <span class="k">continue</span>
</span><span data-line="384">                
</span><span data-line="385">            <span class="c1"># Map submissions to coursework ID</span>
</span><span data-line="386">            <span class="n">submission_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;courseWorkId&#39;</span><span class="p">]:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">}</span>
</span><span data-line="387">            
</span><span data-line="388">            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">course_work</span><span class="p">:</span>
</span><span data-line="389">                <span class="k">if</span> <span class="n">work</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">submission_map</span><span class="p">:</span>
</span><span data-line="390">                    <span class="c1"># It is not turned in.</span>
</span><span data-line="391">                    <span class="n">assignment</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="392">                    <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;courseName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">course</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span data-line="393">                    <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;isMissing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="394">                    <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;isMuted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">work</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">muted_ids</span>
</span><span data-line="395">                    
</span><span data-line="396">                    <span class="k">if</span> <span class="s1">&#39;dueDate&#39;</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
</span><span data-line="397">                        <span class="c1"># Parse due date</span>
</span><span data-line="398">                        <span class="n">due</span> <span class="o">=</span> <span class="n">work</span><span class="p">[</span><span class="s1">&#39;dueDate&#39;</span><span class="p">]</span> <span class="c1"># {year, month, day}</span>
</span><span data-line="399">                        <span class="n">time</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dueTime&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hours&#39;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="s1">&#39;minutes&#39;</span><span class="p">:</span> <span class="mi">59</span><span class="p">})</span>
</span><span data-line="400">                        
</span><span data-line="401">                        <span class="k">try</span><span class="p">:</span>
</span><span data-line="402">                            <span class="n">due_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">due</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">due</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">due</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">],</span> <span class="n">time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hours&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minutes&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span data-line="403">                            <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;dueDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">due_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
</span><span data-line="404">                            
</span><span data-line="405">                            <span class="k">if</span> <span class="n">due_dt</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">:</span>
</span><span data-line="406">                                <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;isMissing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="407">                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span data-line="408">                            <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;dueDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="409">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="410">                        <span class="n">assignment</span><span class="p">[</span><span class="s1">&#39;dueDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="411">                        
</span><span data-line="412">                    <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>
</span><span data-line="413">
</span><span data-line="414">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="415">        <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error fetching missing assignments: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span><span data-line="416">    
</span><span data-line="417">    <span class="c1"># Sort: Missing first, then by due date</span>
</span><span data-line="418">    <span class="k">def</span><span class="w"> </span><span class="nf">sort_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span><span data-line="419">        <span class="n">is_missing</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isMissing&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
</span><span data-line="420">        <span class="n">due</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dueDate&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;9999-99-99&#39;</span>
</span><span data-line="421">        <span class="k">return</span> <span class="p">(</span><span class="n">is_missing</span><span class="p">,</span> <span class="n">due</span><span class="p">)</span>
</span><span data-line="422">        
</span><span data-line="423">    <span class="n">assignments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">)</span>
</span><span data-line="424">    
</span><span data-line="425">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;missing_assignments.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Missing Assignments&#39;</span><span class="p">,</span> <span class="n">assignments</span><span class="o">=</span><span class="n">assignments</span><span class="p">)</span></div>

</span><span data-line="426">
<div class="viewcode-block" id="update_course_order">
<a class="viewcode-back" href="../../app.html#app.routes.update_course_order">[docs]</a>
</span><span data-line="427"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/update_course_order&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span data-line="428"><span class="nd">@login_required</span>
</span><span data-line="429"><span class="k">def</span><span class="w"> </span><span class="nf">update_course_order</span><span class="p">():</span>
</span><span data-line="430"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="431"><span class="sd">    Updates the display order of courses based on drag-and-drop input.</span>
</span><span data-line="432"><span class="sd">    </span>
</span><span data-line="433"><span class="sd">    Expects a JSON payload with an &#39;order&#39; list containing Google Course IDs.</span>
</span><span data-line="434"><span class="sd">    </span>
</span><span data-line="435"><span class="sd">    Returns:</span>
</span><span data-line="436"><span class="sd">        dict: Status dictionary {&#39;status&#39;: &#39;success&#39;}.</span>
</span><span data-line="437"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="438">    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
</span><span data-line="439">    <span class="n">ordered_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="440">    
</span><span data-line="441">    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">google_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_ids</span><span class="p">):</span>
</span><span data-line="442">        <span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">google_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="443">        <span class="k">if</span> <span class="ow">not</span> <span class="n">course</span><span class="p">:</span>
</span><span data-line="444">            <span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">google_id</span><span class="p">)</span>
</span><span data-line="445">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">course</span><span class="p">)</span>
</span><span data-line="446">        
</span><span data-line="447">        <span class="n">course</span><span class="o">.</span><span class="n">display_order</span> <span class="o">=</span> <span class="n">index</span>
</span><span data-line="448">        
</span><span data-line="449">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="450">    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">}</span></div>

</span><span data-line="451">
<div class="viewcode-block" id="edit_course">
<a class="viewcode-back" href="../../app.html#app.routes.edit_course">[docs]</a>
</span><span data-line="452"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/course/&lt;course_id&gt;/edit&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span data-line="453"><span class="nd">@login_required</span>
</span><span data-line="454"><span class="k">def</span><span class="w"> </span><span class="nf">edit_course</span><span class="p">(</span><span class="n">course_id</span><span class="p">):</span>
</span><span data-line="455"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="456"><span class="sd">    Handles editing of course settings (name, section, tags, etc.).</span>
</span><span data-line="457"><span class="sd">    </span>
</span><span data-line="458"><span class="sd">    Args:</span>
</span><span data-line="459"><span class="sd">        course_id (str): The Google Course ID.</span>
</span><span data-line="460"><span class="sd">        </span>
</span><span data-line="461"><span class="sd">    Returns:</span>
</span><span data-line="462"><span class="sd">        str: Rendered HTML template for the edit form or a redirect.</span>
</span><span data-line="463"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="464">    <span class="c1"># Find or create local course record</span>
</span><span data-line="465">    <span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="466">    <span class="k">if</span> <span class="ow">not</span> <span class="n">course</span><span class="p">:</span>
</span><span data-line="467">        <span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span>
</span><span data-line="468">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">course</span><span class="p">)</span>
</span><span data-line="469">    
</span><span data-line="470">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span><span data-line="471">        <span class="n">course</span><span class="o">.</span><span class="n">custom_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_name&#39;</span><span class="p">)</span>
</span><span data-line="472">        <span class="n">course</span><span class="o">.</span><span class="n">custom_section</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_section&#39;</span><span class="p">)</span>
</span><span data-line="473">        <span class="n">course</span><span class="o">.</span><span class="n">custom_code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_code&#39;</span><span class="p">)</span>
</span><span data-line="474">        <span class="n">course</span><span class="o">.</span><span class="n">custom_banner</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_banner&#39;</span><span class="p">)</span>
</span><span data-line="475">        <span class="n">course</span><span class="o">.</span><span class="n">custom_teacher_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_teacher_name&#39;</span><span class="p">)</span>
</span><span data-line="476">        
</span><span data-line="477">        <span class="k">if</span> <span class="s1">&#39;display_order&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
</span><span data-line="478">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="479">                <span class="n">course</span><span class="o">.</span><span class="n">display_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;display_order&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span data-line="480">            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span data-line="481">                <span class="n">course</span><span class="o">.</span><span class="n">display_order</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="482">            
</span><span data-line="483">        <span class="n">course</span><span class="o">.</span><span class="n">is_archived</span> <span class="o">=</span> <span class="s1">&#39;is_archived&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>
</span><span data-line="484">        
</span><span data-line="485">        <span class="c1"># Handle Tags</span>
</span><span data-line="486">        <span class="n">tag_names</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span data-line="487">        <span class="n">tag_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tag_names</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span data-line="488">        
</span><span data-line="489">        <span class="c1"># Clear existing tags</span>
</span><span data-line="490">        <span class="n">course</span><span class="o">.</span><span class="n">user_tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="491">        
</span><span data-line="492">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tag_names</span><span class="p">:</span>
</span><span data-line="493">            <span class="c1"># Check if tag exists for user</span>
</span><span data-line="494">            <span class="n">tag</span> <span class="o">=</span> <span class="n">UserTag</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="495">            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
</span><span data-line="496">                <span class="c1"># Check limit of 12 tags per user</span>
</span><span data-line="497">                <span class="k">if</span> <span class="n">UserTag</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">:</span>
</span><span data-line="498">                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Tag limit reached (12). Could not create tag &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">)</span>
</span><span data-line="499">                    <span class="k">continue</span>
</span><span data-line="500">                <span class="n">tag</span> <span class="o">=</span> <span class="n">UserTag</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="501">                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span data-line="502">            
</span><span data-line="503">            <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">course</span><span class="o">.</span><span class="n">user_tags</span><span class="p">:</span>
</span><span data-line="504">                <span class="n">course</span><span class="o">.</span><span class="n">user_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span data-line="505">        
</span><span data-line="506">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="507">        
</span><span data-line="508">        <span class="c1"># Cleanup unused tags</span>
</span><span data-line="509">        <span class="n">user_tags</span> <span class="o">=</span> <span class="n">UserTag</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span data-line="510">        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">user_tags</span><span class="p">:</span>
</span><span data-line="511">            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="o">.</span><span class="n">courses</span><span class="p">:</span>
</span><span data-line="512">                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span data-line="513">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="514">        
</span><span data-line="515">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Course updated successfully!&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span><span data-line="516">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
</span><span data-line="517">        
</span><span data-line="518">    <span class="c1"># For GET, we might want to fetch the original Google name to show as placeholder</span>
</span><span data-line="519">    <span class="c1"># But for now, let&#39;s just show the form with current local values</span>
</span><span data-line="520">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;edit_course.html&#39;</span><span class="p">,</span> <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span></div>

</span><span data-line="521">
<div class="viewcode-block" id="create_tag">
<a class="viewcode-back" href="../../app.html#app.routes.create_tag">[docs]</a>
</span><span data-line="522"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/course/&lt;course_id&gt;/tags&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span data-line="523"><span class="nd">@login_required</span>
</span><span data-line="524"><span class="k">def</span><span class="w"> </span><span class="nf">create_tag</span><span class="p">(</span><span class="n">course_id</span><span class="p">):</span>
</span><span data-line="525"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="526"><span class="sd">    Creates a new tag for a specific course (Legacy/Specific Tag).</span>
</span><span data-line="527"><span class="sd">    </span>
</span><span data-line="528"><span class="sd">    Args:</span>
</span><span data-line="529"><span class="sd">        course_id (str): The Google Course ID.</span>
</span><span data-line="530"><span class="sd">        </span>
</span><span data-line="531"><span class="sd">    Returns:</span>
</span><span data-line="532"><span class="sd">        redirect: Redirects back to the course stream.</span>
</span><span data-line="533"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="534">    <span class="c1"># Ensure local course exists</span>
</span><span data-line="535">    <span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="536">    <span class="k">if</span> <span class="ow">not</span> <span class="n">course</span><span class="p">:</span>
</span><span data-line="537">        <span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span>
</span><span data-line="538">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">course</span><span class="p">)</span>
</span><span data-line="539">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span> <span class="c1"># Commit to get ID</span>
</span><span data-line="540">    
</span><span data-line="541">    <span class="c1"># Check limit</span>
</span><span data-line="542">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">course</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
</span><span data-line="543">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Limit of 6 tags per class reached.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span><span data-line="544">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;course_stream&#39;</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">))</span>
</span><span data-line="545">        
</span><span data-line="546">    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</span><span data-line="547">    <span class="n">color</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span data-line="548">    
</span><span data-line="549">    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
</span><span data-line="550">        <span class="n">tag</span> <span class="o">=</span> <span class="n">CourseTag</span><span class="p">(</span><span class="n">course_id</span><span class="o">=</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
</span><span data-line="551">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span data-line="552">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="553">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="554">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Tag created!&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span><span data-line="555">        <span class="k">except</span><span class="p">:</span>
</span><span data-line="556">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span data-line="557">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Tag already exists.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span><span data-line="558">            
</span><span data-line="559">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;course_stream&#39;</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">))</span></div>

</span><span data-line="560">
<div class="viewcode-block" id="delete_tag">
<a class="viewcode-back" href="../../app.html#app.routes.delete_tag">[docs]</a>
</span><span data-line="561"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/course/&lt;course_id&gt;/tags/&lt;int:tag_id&gt;/delete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span data-line="562"><span class="nd">@login_required</span>
</span><span data-line="563"><span class="k">def</span><span class="w"> </span><span class="nf">delete_tag</span><span class="p">(</span><span class="n">course_id</span><span class="p">,</span> <span class="n">tag_id</span><span class="p">):</span>
</span><span data-line="564"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="565"><span class="sd">    Deletes a specific course tag.</span>
</span><span data-line="566"><span class="sd">    </span>
</span><span data-line="567"><span class="sd">    Args:</span>
</span><span data-line="568"><span class="sd">        course_id (str): The Google Course ID.</span>
</span><span data-line="569"><span class="sd">        tag_id (int): The ID of the tag to delete.</span>
</span><span data-line="570"><span class="sd">        </span>
</span><span data-line="571"><span class="sd">    Returns:</span>
</span><span data-line="572"><span class="sd">        redirect: Redirects back to the course stream.</span>
</span><span data-line="573"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="574">    <span class="n">tag</span> <span class="o">=</span> <span class="n">CourseTag</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">tag_id</span><span class="p">)</span>
</span><span data-line="575">    <span class="c1"># Verify ownership via course</span>
</span><span data-line="576">    <span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">course_id</span><span class="p">)</span>
</span><span data-line="577">    <span class="k">if</span> <span class="n">course</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="n">course</span><span class="o">.</span><span class="n">google_course_id</span> <span class="o">!=</span> <span class="n">course_id</span><span class="p">:</span>
</span><span data-line="578">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span><span data-line="579">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
</span><span data-line="580">        
</span><span data-line="581">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span data-line="582">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="583">    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Tag deleted.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span><span data-line="584">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;course_stream&#39;</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">))</span></div>

</span><span data-line="585">
<div class="viewcode-block" id="toggle_item_tag">
<a class="viewcode-back" href="../../app.html#app.routes.toggle_item_tag">[docs]</a>
</span><span data-line="586"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/course/&lt;course_id&gt;/items/&lt;item_id&gt;/tags&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span data-line="587"><span class="nd">@login_required</span>
</span><span data-line="588"><span class="k">def</span><span class="w"> </span><span class="nf">toggle_item_tag</span><span class="p">(</span><span class="n">course_id</span><span class="p">,</span> <span class="n">item_id</span><span class="p">):</span>
</span><span data-line="589"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="590"><span class="sd">    Toggles a tag on a specific stream item (assignment).</span>
</span><span data-line="591"><span class="sd">    </span>
</span><span data-line="592"><span class="sd">    Args:</span>
</span><span data-line="593"><span class="sd">        course_id (str): The Google Course ID.</span>
</span><span data-line="594"><span class="sd">        item_id (str): The Google Item ID (assignment ID).</span>
</span><span data-line="595"><span class="sd">        </span>
</span><span data-line="596"><span class="sd">    Returns:</span>
</span><span data-line="597"><span class="sd">        redirect: Redirects back to the course stream.</span>
</span><span data-line="598"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="599">    <span class="n">tag_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag_id&#39;</span><span class="p">)</span>
</span><span data-line="600">    <span class="k">if</span> <span class="ow">not</span> <span class="n">tag_id</span><span class="p">:</span>
</span><span data-line="601">        <span class="k">return</span> <span class="s1">&#39;Missing tag_id&#39;</span><span class="p">,</span> <span class="mi">400</span>
</span><span data-line="602">        
</span><span data-line="603">    <span class="n">tag</span> <span class="o">=</span> <span class="n">CourseTag</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tag_id</span><span class="p">))</span>
</span><span data-line="604">    <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
</span><span data-line="605">        <span class="k">return</span> <span class="s1">&#39;Tag not found&#39;</span><span class="p">,</span> <span class="mi">404</span>
</span><span data-line="606">        
</span><span data-line="607">    <span class="c1"># Check if already assigned</span>
</span><span data-line="608">    <span class="n">assignment</span> <span class="o">=</span> <span class="n">ItemTag</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">tag_id</span><span class="o">=</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="609">    
</span><span data-line="610">    <span class="k">if</span> <span class="n">assignment</span><span class="p">:</span>
</span><span data-line="611">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>
</span><span data-line="612">        <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;removed&#39;</span>
</span><span data-line="613">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="614">        <span class="n">assignment</span> <span class="o">=</span> <span class="n">ItemTag</span><span class="p">(</span><span class="n">tag_id</span><span class="o">=</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">)</span>
</span><span data-line="615">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>
</span><span data-line="616">        <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;added&#39;</span>
</span><span data-line="617">        
</span><span data-line="618">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="619">    
</span><span data-line="620">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;course_stream&#39;</span><span class="p">,</span> <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">))</span></div>

</span><span data-line="621">
<div class="viewcode-block" id="toggle_mute_assignment">
<a class="viewcode-back" href="../../app.html#app.routes.toggle_mute_assignment">[docs]</a>
</span><span data-line="622"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/mute_assignment/&lt;item_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span data-line="623"><span class="nd">@login_required</span>
</span><span data-line="624"><span class="k">def</span><span class="w"> </span><span class="nf">toggle_mute_assignment</span><span class="p">(</span><span class="n">item_id</span><span class="p">):</span>
</span><span data-line="625"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="626"><span class="sd">    Toggles the muted state of an assignment (hides/shows it in Missing Assignments).</span>
</span><span data-line="627"><span class="sd">    </span>
</span><span data-line="628"><span class="sd">    Args:</span>
</span><span data-line="629"><span class="sd">        item_id (str): The Google Item ID.</span>
</span><span data-line="630"><span class="sd">        </span>
</span><span data-line="631"><span class="sd">    Returns:</span>
</span><span data-line="632"><span class="sd">        dict: JSON status if AJAX request.</span>
</span><span data-line="633"><span class="sd">        redirect: Redirects to missing assignments page if standard request.</span>
</span><span data-line="634"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="635">    <span class="n">muted</span> <span class="o">=</span> <span class="n">MutedItem</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="636">    <span class="k">if</span> <span class="n">muted</span><span class="p">:</span>
</span><span data-line="637">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">muted</span><span class="p">)</span>
</span><span data-line="638">        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unmuted&#39;</span>
</span><span data-line="639">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="640">        <span class="n">muted</span> <span class="o">=</span> <span class="n">MutedItem</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">)</span>
</span><span data-line="641">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">muted</span><span class="p">)</span>
</span><span data-line="642">        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;muted&#39;</span>
</span><span data-line="643">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="644">    
</span><span data-line="645">    <span class="c1"># Return JSON if AJAX, else redirect</span>
</span><span data-line="646">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_json</span><span class="p">:</span>
</span><span data-line="647">        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">}</span>
</span><span data-line="648">    
</span><span data-line="649">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;missing_assignments&#39;</span><span class="p">))</span></div>

</span><span data-line="650">
<div class="viewcode-block" id="course_stream">
<a class="viewcode-back" href="../../app.html#app.routes.course_stream">[docs]</a>
</span><span data-line="651"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/course/&lt;course_id&gt;&#39;</span><span class="p">)</span>
</span><span data-line="652"><span class="nd">@login_required</span>
</span><span data-line="653"><span class="k">def</span><span class="w"> </span><span class="nf">course_stream</span><span class="p">(</span><span class="n">course_id</span><span class="p">):</span>
</span><span data-line="654"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="655"><span class="sd">    Renders the stream view for a specific course.</span>
</span><span data-line="656"><span class="sd">    </span>
</span><span data-line="657"><span class="sd">    Fetches announcements, coursework, and materials from Google Classroom.</span>
</span><span data-line="658"><span class="sd">    Merges with local tag data.</span>
</span><span data-line="659"><span class="sd">    </span>
</span><span data-line="660"><span class="sd">    Args:</span>
</span><span data-line="661"><span class="sd">        course_id (str): The Google Course ID.</span>
</span><span data-line="662"><span class="sd">        </span>
</span><span data-line="663"><span class="sd">    Returns:</span>
</span><span data-line="664"><span class="sd">        str: Rendered HTML template for the course stream.</span>
</span><span data-line="665"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="666">    <span class="c1"># Build credentials</span>
</span><span data-line="667">    <span class="n">credentials</span> <span class="o">=</span> <span class="n">Credentials</span><span class="p">(</span>
</span><span data-line="668">        <span class="n">token</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">access_token</span><span class="p">,</span>
</span><span data-line="669">        <span class="n">refresh_token</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
</span><span data-line="670">        <span class="n">token_uri</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">token_uri</span><span class="p">,</span>
</span><span data-line="671">        <span class="n">client_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
</span><span data-line="672">        <span class="n">client_secret</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">client_secret</span><span class="p">,</span>
</span><span data-line="673">        <span class="n">scopes</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span> <span class="k">else</span> <span class="p">[]</span>
</span><span data-line="674">    <span class="p">)</span>
</span><span data-line="675">    
</span><span data-line="676">    <span class="c1"># Force refresh if needed (though google-auth usually handles this)</span>
</span><span data-line="677">    <span class="k">if</span> <span class="n">credentials</span><span class="o">.</span><span class="n">expired</span><span class="p">:</span>
</span><span data-line="678">        <span class="n">request_adapter</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>
</span><span data-line="679">        <span class="n">credentials</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">request_adapter</span><span class="p">)</span>
</span><span data-line="680">        <span class="c1"># Update DB with new token</span>
</span><span data-line="681">        <span class="n">current_user</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">token</span>
</span><span data-line="682">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="683">    
</span><span data-line="684">    <span class="n">service</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="s1">&#39;classroom&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">)</span>
</span><span data-line="685">    
</span><span data-line="686">    <span class="c1"># Fetch Course Details (for banner/name)</span>
</span><span data-line="687">    <span class="k">try</span><span class="p">:</span>
</span><span data-line="688">        <span class="n">google_course</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="689">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="690">        <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error fetching course: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
</span><span data-line="691">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
</span><span data-line="692">
</span><span data-line="693">    <span class="c1"># Apply local overrides</span>
</span><span data-line="694">    <span class="n">local_course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">google_course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="695">    <span class="n">course</span> <span class="o">=</span> <span class="n">google_course</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="696">    
</span><span data-line="697">    <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="698">    <span class="n">item_tags_map</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="699">
</span><span data-line="700">    <span class="k">if</span> <span class="n">local_course</span><span class="p">:</span>
</span><span data-line="701">        <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_name</span><span class="p">:</span> <span class="n">course</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_name</span>
</span><span data-line="702">        <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_section</span><span class="p">:</span> <span class="n">course</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_section</span>
</span><span data-line="703">        <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_banner</span><span class="p">:</span> <span class="n">course</span><span class="p">[</span><span class="s1">&#39;custom_banner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_banner</span>
</span><span data-line="704">        <span class="k">if</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_code</span><span class="p">:</span> <span class="n">course</span><span class="p">[</span><span class="s1">&#39;enrollmentCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">custom_code</span>
</span><span data-line="705">        
</span><span data-line="706">        <span class="n">tags</span> <span class="o">=</span> <span class="n">local_course</span><span class="o">.</span><span class="n">tags</span>
</span><span data-line="707">        <span class="n">tag_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
</span><span data-line="708">        <span class="k">if</span> <span class="n">tag_ids</span><span class="p">:</span>
</span><span data-line="709">            <span class="n">assignments</span> <span class="o">=</span> <span class="n">ItemTag</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ItemTag</span><span class="o">.</span><span class="n">tag_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">tag_ids</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span data-line="710">            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
</span><span data-line="711">                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">google_item_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item_tags_map</span><span class="p">:</span>
</span><span data-line="712">                    <span class="n">item_tags_map</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">google_item_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="713">                <span class="n">tag_obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">tag_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="714">                <span class="k">if</span> <span class="n">tag_obj</span><span class="p">:</span>
</span><span data-line="715">                    <span class="n">item_tags_map</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">google_item_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_obj</span><span class="p">)</span>
</span><span data-line="716">    
</span><span data-line="717">    <span class="c1"># Fetch Stream Items</span>
</span><span data-line="718">    <span class="n">stream_items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="719">    
</span><span data-line="720">    <span class="c1"># Debug: Print current scopes</span>
</span><span data-line="721">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current User Scopes: </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="722">
</span><span data-line="723">    <span class="k">try</span><span class="p">:</span>
</span><span data-line="724">        <span class="c1"># 1. Announcements</span>
</span><span data-line="725">        <span class="n">announcements</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">announcements</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">courseId</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;announcements&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="726">        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">announcements</span><span class="p">:</span>
</span><span data-line="727">            <span class="n">a</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;announcement&#39;</span>
</span><span data-line="728">            <span class="n">stream_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span data-line="729">            
</span><span data-line="730">        <span class="c1"># 2. CourseWork (Assignments, Questions)</span>
</span><span data-line="731">        <span class="n">coursework</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">courseWork</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">courseId</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courseWork&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="732">        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">coursework</span><span class="p">:</span>
</span><span data-line="733">            <span class="n">w</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;assignment&#39;</span> <span class="c1"># or &#39;question&#39; based on workType</span>
</span><span data-line="734">            <span class="n">stream_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span data-line="735">            
</span><span data-line="736">        <span class="c1"># 3. CourseWorkMaterials</span>
</span><span data-line="737">        <span class="n">materials</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">courses</span><span class="p">()</span><span class="o">.</span><span class="n">courseWorkMaterials</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">courseId</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;courseWorkMaterial&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span data-line="738">        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">materials</span><span class="p">:</span>
</span><span data-line="739">            <span class="n">m</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;material&#39;</span>
</span><span data-line="740">            <span class="n">stream_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span data-line="741">            
</span><span data-line="742">    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="743">        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
</span><span data-line="744">            <span class="c1"># Check for missing scopes</span>
</span><span data-line="745">            <span class="n">required_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;GOOGLE_SCOPES&#39;</span><span class="p">])</span>
</span><span data-line="746">            <span class="n">current_scopes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">scopes</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="747">            
</span><span data-line="748">            <span class="n">missing_scopes</span> <span class="o">=</span> <span class="n">required_scopes</span> <span class="o">-</span> <span class="n">current_scopes</span>
</span><span data-line="749">            <span class="k">if</span> <span class="n">missing_scopes</span><span class="p">:</span>
</span><span data-line="750">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing scopes: </span><span class="si">{</span><span class="n">missing_scopes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="751">                <span class="n">logout_user</span><span class="p">()</span>
</span><span data-line="752">                <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;New permissions are required. Please log in again to grant them.&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span><span data-line="753">                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span><span data-line="754">                
</span><span data-line="755">        <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error fetching stream: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">)</span>
</span><span data-line="756">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="757">        <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error fetching stream: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">)</span>
</span><span data-line="758">
</span><span data-line="759">    <span class="c1"># Sort by creation time (newest first)</span>
</span><span data-line="760">    <span class="c1"># Note: Different items have different time fields (creationTime, updateTime)</span>
</span><span data-line="761">    <span class="k">def</span><span class="w"> </span><span class="nf">get_sort_time</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
</span><span data-line="762">        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;creationTime&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updateTime&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;1970-01-01T00:00:00.000Z&#39;</span>
</span><span data-line="763">        
</span><span data-line="764">    <span class="n">stream_items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">get_sort_time</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="765">
</span><span data-line="766">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;course_stream.html&#39;</span><span class="p">,</span> <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span> <span class="n">stream_items</span><span class="o">=</span><span class="n">stream_items</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">item_tags_map</span><span class="o">=</span><span class="n">item_tags_map</span><span class="p">)</span></div>

</span><span data-line="767">
<div class="viewcode-block" id="sync_calendar">
<a class="viewcode-back" href="../../app.html#app.routes.sync_calendar">[docs]</a>
</span><span data-line="768"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/sync_calendar&#39;</span><span class="p">)</span>
</span><span data-line="769"><span class="nd">@login_required</span>
</span><span data-line="770"><span class="k">def</span><span class="w"> </span><span class="nf">sync_calendar</span><span class="p">():</span>
</span><span data-line="771"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="772"><span class="sd">    Placeholder route for calendar synchronization.</span>
</span><span data-line="773"><span class="sd">    </span>
</span><span data-line="774"><span class="sd">    Returns:</span>
</span><span data-line="775"><span class="sd">        redirect: Redirects to index with a &#39;coming soon&#39; message.</span>
</span><span data-line="776"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="777">    <span class="c1"># Placeholder for calendar sync logic</span>
</span><span data-line="778">    <span class="c1"># 1. Fetch assignments from Google Classroom</span>
</span><span data-line="779">    <span class="c1"># 2. Check if they exist in Google Calendar</span>
</span><span data-line="780">    <span class="c1"># 3. If not, add them</span>
</span><span data-line="781">    
</span><span data-line="782">    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Calendar sync feature coming soon!&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span><span data-line="783">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span></div>

</span><span data-line="784">
<div class="viewcode-block" id="login">
<a class="viewcode-back" href="../../app.html#app.routes.login">[docs]</a>
</span><span data-line="785"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span><span data-line="786"><span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
</span><span data-line="787"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="788"><span class="sd">    Initiates the Google OAuth login flow.</span>
</span><span data-line="789"><span class="sd">    </span>
</span><span data-line="790"><span class="sd">    Returns:</span>
</span><span data-line="791"><span class="sd">        redirect: Redirects the user to Google&#39;s authorization URL.</span>
</span><span data-line="792"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="793">    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
</span><span data-line="794">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
</span><span data-line="795">        
</span><span data-line="796">    <span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="o">.</span><span class="n">from_client_secrets_file</span><span class="p">(</span>
</span><span data-line="797">        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;GOOGLE_CLIENT_SECRETS_FILE&#39;</span><span class="p">],</span>
</span><span data-line="798">        <span class="n">scopes</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;GOOGLE_SCOPES&#39;</span><span class="p">]</span>
</span><span data-line="799">    <span class="p">)</span>
</span><span data-line="800">    <span class="n">flow</span><span class="o">.</span><span class="n">redirect_uri</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="801">    <span class="n">authorization_url</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">authorization_url</span><span class="p">(</span>
</span><span data-line="802">        <span class="n">access_type</span><span class="o">=</span><span class="s1">&#39;offline&#39;</span><span class="p">,</span>
</span><span data-line="803">        <span class="n">include_granted_scopes</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
</span><span data-line="804">        <span class="n">prompt</span><span class="o">=</span><span class="s1">&#39;consent&#39;</span> <span class="c1"># Force consent screen to ensure new scopes are granted</span>
</span><span data-line="805">    <span class="p">)</span>
</span><span data-line="806">    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
</span><span data-line="807">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">authorization_url</span><span class="p">)</span></div>

</span><span data-line="808">
<div class="viewcode-block" id="callback">
<a class="viewcode-back" href="../../app.html#app.routes.callback">[docs]</a>
</span><span data-line="809"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/callback&#39;</span><span class="p">)</span>
</span><span data-line="810"><span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">():</span>
</span><span data-line="811"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="812"><span class="sd">    Handles the callback from Google OAuth.</span>
</span><span data-line="813"><span class="sd">    </span>
</span><span data-line="814"><span class="sd">    Exchanges the authorization code for tokens, fetches user info,</span>
</span><span data-line="815"><span class="sd">    creates/updates the user record in the database, and logs the user in.</span>
</span><span data-line="816"><span class="sd">    </span>
</span><span data-line="817"><span class="sd">    Returns:</span>
</span><span data-line="818"><span class="sd">        redirect: Redirects to the index page upon success.</span>
</span><span data-line="819"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="820">    <span class="n">state</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>
</span><span data-line="821">    <span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="o">.</span><span class="n">from_client_secrets_file</span><span class="p">(</span>
</span><span data-line="822">        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;GOOGLE_CLIENT_SECRETS_FILE&#39;</span><span class="p">],</span>
</span><span data-line="823">        <span class="n">scopes</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;GOOGLE_SCOPES&#39;</span><span class="p">],</span>
</span><span data-line="824">        <span class="n">state</span><span class="o">=</span><span class="n">state</span>
</span><span data-line="825">    <span class="p">)</span>
</span><span data-line="826">    <span class="n">flow</span><span class="o">.</span><span class="n">redirect_uri</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;callback&#39;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="827">
</span><span data-line="828">    <span class="n">authorization_response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
</span><span data-line="829">    <span class="c1"># Allow for scope changes/upgrades</span>
</span><span data-line="830">    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OAUTHLIB_RELAX_TOKEN_SCOPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
</span><span data-line="831">    <span class="n">flow</span><span class="o">.</span><span class="n">fetch_token</span><span class="p">(</span><span class="n">authorization_response</span><span class="o">=</span><span class="n">authorization_response</span><span class="p">)</span>
</span><span data-line="832">
</span><span data-line="833">    <span class="n">credentials</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">credentials</span>
</span><span data-line="834">    
</span><span data-line="835">    <span class="c1"># Get user info</span>
</span><span data-line="836">    <span class="n">service</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="s1">&#39;oauth2&#39;</span><span class="p">,</span> <span class="s1">&#39;v2&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">)</span>
</span><span data-line="837">    <span class="n">user_info</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">userinfo</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="838">    
</span><span data-line="839">    <span class="n">google_id</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span><span data-line="840">    <span class="n">email</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span><span data-line="841">    <span class="n">name</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</span><span data-line="842">    <span class="n">picture</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;picture&#39;</span><span class="p">)</span>
</span><span data-line="843">
</span><span data-line="844">    <span class="c1"># Check if user exists</span>
</span><span data-line="845">    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">google_id</span><span class="o">=</span><span class="n">google_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span data-line="846">    
</span><span data-line="847">    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span data-line="848">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">google_id</span><span class="o">=</span><span class="n">google_id</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
</span><span data-line="849">    
</span><span data-line="850">    <span class="c1"># Update user info and tokens</span>
</span><span data-line="851">    <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span data-line="852">    <span class="n">user</span><span class="o">.</span><span class="n">picture</span> <span class="o">=</span> <span class="n">picture</span>
</span><span data-line="853">    <span class="n">user</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">token</span>
</span><span data-line="854">    <span class="n">user</span><span class="o">.</span><span class="n">refresh_token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">refresh_token</span>
</span><span data-line="855">    <span class="n">user</span><span class="o">.</span><span class="n">token_uri</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">token_uri</span>
</span><span data-line="856">    <span class="n">user</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">client_id</span>
</span><span data-line="857">    <span class="n">user</span><span class="o">.</span><span class="n">client_secret</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">client_secret</span>
</span><span data-line="858">    <span class="n">user</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">scopes</span><span class="p">)</span> <span class="k">if</span> <span class="n">credentials</span><span class="o">.</span><span class="n">scopes</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span><span data-line="859">    
</span><span data-line="860">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span data-line="861">    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="862">    
</span><span data-line="863">    <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">remember</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="864">
</span><span data-line="865">    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Successfully logged in!&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span><span data-line="866">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span></div>

</span><span data-line="867">
<div class="viewcode-block" id="logout">
<a class="viewcode-back" href="../../app.html#app.routes.logout">[docs]</a>
</span><span data-line="868"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
</span><span data-line="869"><span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">():</span>
</span><span data-line="870"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="871"><span class="sd">    Logs the user out.</span>
</span><span data-line="872"><span class="sd">    </span>
</span><span data-line="873"><span class="sd">    Returns:</span>
</span><span data-line="874"><span class="sd">        redirect: Redirects to the index page.</span>
</span><span data-line="875"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="876">    <span class="n">logout_user</span><span class="p">()</span>
</span><span data-line="877">    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;You have been logged out.&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span><span data-line="878">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span></div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Paarth Siloiya</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=c1cf1a6b"></script></body>
</html>