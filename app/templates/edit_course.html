{% extends "base.html" %} {% block content %}
<div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
    <h1 class="text-2xl font-bold mb-6 dark:text-white">Edit Course</h1>

    <form action="{{ url_for('edit_course', course_id=google_course_id) }}" method="POST">
        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="custom_name"> Custom Name </label>
            <input
                class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="custom_name"
                name="custom_name"
                type="text"
                placeholder="Enter custom course name"
                value="{{ course.custom_name if course.custom_name else '' }}"
            />
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="custom_section"> Custom Section </label>
            <input
                class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="custom_section"
                name="custom_section"
                type="text"
                placeholder="Enter custom section"
                value="{{ course.custom_section if course.custom_section else '' }}"
            />
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="custom_code"> Custom Class Code (Display Only) </label>
            <input
                class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="custom_code"
                name="custom_code"
                type="text"
                placeholder="Enter custom code"
                value="{{ course.custom_code if course.custom_code else '' }}"
            />
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="custom_banner"> Custom Banner URL </label>
            <input
                class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="custom_banner"
                name="custom_banner"
                type="text"
                placeholder="https://example.com/image.jpg"
                value="{{ course.custom_banner if course.custom_banner else '' }}"
            />
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="custom_teacher_name"> Custom Teacher Name </label>
            <input
                class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="custom_teacher_name"
                name="custom_teacher_name"
                type="text"
                placeholder="Enter custom teacher name"
                value="{{ course.custom_teacher_name if course.custom_teacher_name else '' }}"
            />
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="tags"> Tags (Max 12 total) </label>

            <div
                id="tag-input-container"
                class="flex flex-wrap items-center gap-2 shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 bg-white dark:bg-gray-700 focus-within:ring-2 focus-within:ring-blue-500 transition-shadow cursor-text"
                onclick="document.getElementById('tag-input').focus()"
            >
                <!-- Tags will be inserted here -->
                <input id="tag-input" type="text" class="flex-grow bg-transparent outline-none text-gray-700 dark:text-gray-200 min-w-[80px] text-sm" placeholder="Add a tag..." />
            </div>

            <input type="hidden" name="tags" id="hidden-tags-input" value="{{ course.user_tags|map(attribute='name')|join(',') }}" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Press Enter or Comma to add a tag. Backspace to remove.</p>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const container = document.getElementById("tag-input-container");
                const input = document.getElementById("tag-input");
                const hiddenInput = document.getElementById("hidden-tags-input");

                let tags = hiddenInput.value
                    .split(",")
                    .map((t) => t.trim())
                    .filter((t) => t);

                function renderTags() {
                    // Remove existing tag elements (keep input)
                    const existingTags = container.querySelectorAll(".tag-capsule");
                    existingTags.forEach((el) => el.remove());

                    // Insert tags before input
                    tags.forEach((tag, index) => {
                        const tagEl = document.createElement("div");
                        tagEl.className = "tag-capsule flex items-center gap-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-md text-sm font-medium";
                        tagEl.innerHTML = `
                            <span>${tag}</span>
                            <button type="button" class="hover:text-blue-600 dark:hover:text-blue-100 focus:outline-none" onclick="removeTag(${index})">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        `;
                        container.insertBefore(tagEl, input);
                    });

                    hiddenInput.value = tags.join(",");
                }

                window.removeTag = function (index) {
                    tags.splice(index, 1);
                    renderTags();
                };

                input.addEventListener("keydown", function (e) {
                    if (e.key === "Enter" || e.key === ",") {
                        e.preventDefault();
                        const val = input.value.trim().replace(",", "");
                        if (val && !tags.includes(val)) {
                            if (tags.length >= 12) {
                                alert("Tag limit reached (12)");
                                return;
                            }
                            tags.push(val);
                            input.value = "";
                            renderTags();
                        } else if (tags.includes(val)) {
                            input.value = ""; // Clear duplicate
                        }
                    } else if (e.key === "Backspace" && !input.value && tags.length > 0) {
                        tags.pop();
                        renderTags();
                    }
                });

                // Initial render
                renderTags();
            });
        </script>

        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="display_order"> Display Order (Lower numbers first) </label>
            <input
                class="shadow appearance-none border dark:border-gray-600 rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="display_order"
                name="display_order"
                type="number"
                placeholder="0"
                value="{{ course.display_order if course.display_order else 0 }}"
            />
        </div>

        <div class="mb-6">
            <label class="flex items-center">
                <input type="checkbox" name="is_archived" class="form-checkbox h-5 w-5 text-blue-600" {% if course.is_archived %}checked{% endif %} />
                <span class="ml-2 text-gray-700 dark:text-gray-300">Archive this class (Hide from dashboard)</span>
            </label>
        </div>

        <div class="flex items-center justify-between">
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">Save Changes</button>
            <a href="{{ url_for('index') }}" class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"> Cancel </a>
        </div>
    </form>
</div>
{% endblock %}
